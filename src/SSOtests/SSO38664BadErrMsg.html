<html>
<head>

<script src="http://cdn.kendostatic.com/2014.3.1316/js/jquery.min.js"></script>
<script src="http://nbbedwhenshaw2.bedford.progress.com:8810/_jsdo/progress.jsdo.js"></script>


<script src="http://nbbedwhenshaw2.bedford.progress.com:8810/_jsdo/progress.js"></script>

<script src="http://nbbedwhenshaw2.bedford.progress.com:8810/_jsdo/progress.session.js"></script>

<script src="http://nbbedwhenshaw2.bedford.progress.com:8810/_jsdo/progress.auth.js"></script>

</head>
<body>
<div id="correct">
    CORRECT OUTPUT<br/>
<br/>
</div>     

<div id="outdiv"/>
<br/>
<br/>
   TEST OUTPUT
<br/>
 
<script> 

(function () {
    "use strict";
    
    /*global progress, console, sessionStorage, document  */
    /*global simpleTest, outputMsgs, finishTest, cleanStorage, logResult, callFill*/
    /*global handleFillResponse, callLogout, handleLogoutResponse*/
    
    
    var authenticationSettings = {
            authenticationURI : "http://localhost:8810/TokenServer0331/static/auth/j_spring_security_check"
        },
        jsdoSettings = {
            serviceURI: "http://nbbedwhenshaw2:8810/SSOwh0331",
            authenticationModel : progress.data.Session.AUTH_TYPE_OECP,
            authImpl: {provider: undefined,
                       consumer: {
                                    tokenRequestDescriptor: {
                                        type: progress.data.Session.HTTP_HEADER,
                                        headerName: ""
                                    }
                       }
            },
            catalogURIs: [
                "http://nbbedwhenshaw2:8810/SSOwh0331/static/SSOwh0331Service.json"
            ]
        },
        correctOutputString,
        correctOutputMsgs = [
            "*",
            "* * * * * * * * * * * * * * * * * * simpleTest * * * * * * * * * * * * * * * * * ",
            "Error thrown as expected calling AuthenticationProvider constructor",
            "errorObject: Error: AuthenticationProvider: 'tokenResponseDescriptor' objects must contain a 'type' property.",
            "The authentication call succeeded.",
            "Error thrown as expected calling JSDOSession constructor with no provider.",
            "errorObject: Error: JSDOSession: Invalid signature for the constructor. The authImpl property of the options parameter must have a provider object property.",
            "Error thrown as expected calling JSDOSession constructor with a consumer that is not an object.",
            "errorObject: Error: JSDOSession: Invalid signature for the constructor. The authImpl.consumer property of the options parameter must be an object if it is present."

        ],
        actualOutputMsgs = [],
        jsdoSession,
        authProvider,
        msgAuthSucceeded = "The authentication call succeeded.",
        msgBUGUnexpectedFailure = "BUG: Call to authenticate() failed unexpectedly",
        msgBUGUnexpectedSuccess = "BUG: Call to authenticate() succeeded unexpectedly";

    // Put the correct output on the page for convenient reference. Also returns the output as a string
    // to save for comparison with the actual output later
    correctOutputString = outputMsgs(correctOutputMsgs, document.getElementById("correct"));

    function startSimpleTest() {
        actualOutputMsgs.push("*");
        actualOutputMsgs.push("* * * * * * * * * * * * * * * * * * simpleTest * * * * * * * * * * * * * * * * * ");
        simpleTest();
    }
    
    startSimpleTest();
    
    function finishSimpleTest() {
        cleanStorage();
        finishTest();
    }
    
    function simpleTest() {
        var promise,
            authProvider;
            
        try {
            cleanStorage();
            
            try {
                authProvider = new progress.data.AuthenticationProvider(
                                                      authenticationSettings.authenticationURI,
                                                      {tokenResponseDescriptor: { headerName : "header"}});
            } catch(e) {
                console.log("error from AuthenticationProvider constructor:\n" + e);
                logResult("Error thrown as expected calling AuthenticationProvider constructor",
                          e,
                          authenticationSettings);
            }
            authProvider = new progress.data.AuthenticationProvider(
                                                  authenticationSettings.authenticationURI);
                                                    
            promise = authProvider.authenticate({ userName: "restuser", password: "password"});
            promise.done(function (ap, result, info) {
                logResult(msgAuthSucceeded, null, authenticationSettings);
                // test error when no provider is provided to the constructor
                try {
                    jsdoSession = new progress.data.JSDOSession(jsdoSettings);
                } catch(e) {
                    logResult("Error thrown as expected calling JSDOSession constructor with no provider.",
                              e,
                              authenticationSettings);
                }
                // test error when authImpl.consumer is not an object
                try {
                    jsdoSettings.authImpl.provider = authProvider;
                    jsdoSettings.authImpl.consumer = 99;
                    jsdoSession = new progress.data.JSDOSession(jsdoSettings);
                } catch(e) {
                    logResult("Error thrown as expected calling JSDOSession constructor with a consumer that is not an object.",
                              e,
                              authenticationSettings);
                }
                finishSimpleTest();
            });
            promise.fail(function (ap, result, info) {
                logResult(msgBUGUnexpectedFailure + ", result: " + result, info.errorObject, authenticationSettings);
                finishSimpleTest();
            });

        } catch (f) {
            logResult("BUG: Error thrown calling authenticate(): ", f, authenticationSettings);
            finishSimpleTest();
        }
    }

    // clean up storage (can delete this when we add the invalidate() method to AuthenticationProvider)
    function cleanStorage() {
        sessionStorage.removeItem(authenticationSettings.authenticationURI);
        sessionStorage.removeItem(authenticationSettings.id);  // in case we use the id property        
    }
    
    // clean up storage (can delete this when we add the invalidate() method to AuthenticationProvider)
    function logResult(resultMsg, errorObject, authenticationSettings) {
        //var id = authenticationSettings.id || authenticationSettings.authenticationURI,
        var id = authenticationSettings.authenticationURI,
            token;
        actualOutputMsgs.push(resultMsg);
        if (errorObject) {
            actualOutputMsgs.push("errorObject: " + errorObject);           
        }
    }
    
    function finishTest() {
        var lineIdx,
            charIdx,
            msgs = [],
            outputString;
        
       // spit out the actual output. Also returns the output as a string for easy comparison
       // with the correct output, which was set into correctOutputString at the beginning of the test
        outputString = outputMsgs(actualOutputMsgs, document.getElementById("outdiv"));

        msgs.push(" ");
        if (outputString === correctOutputString) {
            msgs.push("       TEST PASSED");
        } else {
            msgs.push("       TEST FAILED !!!!!!!!!!!!!  see console for details");
            // uncomment this to identify the correct and actual output lines that don't match 
     
            for (lineIdx = 0; lineIdx < correctOutputMsgs.length; lineIdx += 1) {
                if (actualOutputMsgs[lineIdx] !== correctOutputMsgs[lineIdx]) {
                    console.log("MISMATCH ON LINE " + (lineIdx + 1) + "\n   correct: " + correctOutputMsgs[lineIdx] + "\n   actual: " + actualOutputMsgs[lineIdx]);
                    // uncomment this to identify the correct and actual output characters that don't match 

                    for (charIdx = 0; charIdx < correctOutputMsgs[lineIdx].length; charIdx += 1) {
                        if (actualOutputMsgs[lineIdx][charIdx] !== correctOutputMsgs[lineIdx][charIdx]) {
                            console.log(charIdx + "   " + actualOutputMsgs[lineIdx][charIdx] + "   " + correctOutputMsgs[lineIdx][charIdx]);
                        }
                    }

                }
            }
    
        }
        outputMsgs(msgs, document.getElementById("outdiv"));
    }

    function outputMsgs(msgs, writeElement) {
        var arrayLength,
            arrayIndex,
            outMsg = "",
            consolemsg = " ";

        if (writeElement) {
             outMsg = writeElement.innerHTML;
        }
        
        arrayLength = msgs.length;
        for (arrayIndex = 0; arrayIndex < arrayLength; arrayIndex = arrayIndex + 1) {
            outMsg = outMsg + "<br>" + msgs[arrayIndex];
            consolemsg = consolemsg + "\n" + msgs[arrayIndex];
        }
        
        if (writeElement) {
            writeElement.innerHTML = outMsg;
           // document.getElementById("theid").innerHTML=word;
            //document.write(outMsg);
         //   outMsg = htmlTarget["html"]() + msg;
           // htmlTarget["html"](outMsg);
        }
        
        
        console.log(consolemsg); 
        return consolemsg;
    }
    
}());

</script>

</body>

</html>
